<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Corrosion Rate Measurement Simulator</title>
    <style>
        :root {
            --main-bg: #1C2833;
            --panel-bg: #232b3a;
            --accent: #00FFF7;
            --accent2: #E3FAF8;
            --text-main: #ECF0F1;
            --slider-thumb: #00FFF7;
            --slider-track: #2d3748;
            --slider-fill: #00FFF7;
            --glass: #aee7ff;
        }
        
        html, body { width: 100vw; height: 100vh; margin: 0; padding: 0; font-family: Arial, sans-serif; background: var(--main-bg); color: var(--text-main); overflow: hidden;}
        #header-bar { width: 100vw; height: 8vh; background: linear-gradient(90deg, #1c2833 0%, #00FFF7 100%); display: flex; align-items: center; justify-content: center; font-size: 3.7vh; font-weight: bolder; letter-spacing: 1.7px; box-shadow: 0 2px 14px #000a; color: var(--text-main); border-radius: 0; position: relative;}
        #header-title { flex: 1 1 auto; text-align: center; font-size: 3.7vh; font-weight: bolder; letter-spacing: 1.7px; text-shadow: 0 3px 16px #00FFF733, 0 1px 0 #fff6;}
        #main-content { display: flex; width: 100vw; height: calc(92vh - 0px); min-height: 440px; background: transparent; position: relative;}
        #controls-panel { width: 32%; min-width: 310px; max-height: 100vh; padding: 0; background: var(--panel-bg); border-top-left-radius: 32px; border-bottom-left-radius: 32px; border-top-right-radius: 0; border-bottom-right-radius: 0; display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2;}
        #controls-content { width: 96%; z-index: 1; display: flex; flex-direction: column; padding: 3.2vh 1.2vw 1.8vh 1.2vw; gap: 1.6vh; box-sizing: border-box;}
        .param-group { margin-bottom: 1.1vh; display: flex; flex-direction: column; gap: 0.3vh; align-items: center;}
        .param-group label { font-size: 2.15vh; font-weight: 800; color: var(--accent); letter-spacing: 0.2px; text-align: center; margin-bottom: 0.2vh; word-break: break-word; white-space: normal;}
        .image-button-group { display: flex; gap: 2vw; margin-bottom: 0.2vh; justify-content: center;}
        .img-btn { border: 2.4px solid #334155; border-radius: 18px; background: var(--btn-bg, #23395d); padding: 1.4vh 1.7vw 1.2vh 1.7vw; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: border 0.2s, background 0.2s, transform 0.16s, box-shadow 0.17s; font-size: 2.1vh; outline: none; color: var(--text-main); box-shadow: 0 1px 6px #0002; position: relative; min-width: 78px;}
        .img-btn.selected, .img-btn:focus { border: 2.4px solid var(--accent); background: #202e44; z-index: 2;}
        .img-btn:hover:not(:disabled) { border: 2.4px solid var(--accent); background: var(--btn-hover, #00FFF7); transform: scale(1.13); color: #222; z-index: 2; box-shadow: 0 3px 26px #00fff733;}
        .img-btn img { width: 54px; height: 54px; margin-bottom: 0.5vh; filter: drop-shadow(0 0 2px #fff4) brightness(1.09);}
        .img-btn span { color: inherit; margin-top: 0.1vh; font-weight: 700; font-size: 1.32vh; letter-spacing: 0.19vw;}
        .img-btn .metal-code, .img-btn .elec-code { font-weight: bold; font-size: 1.8vh; color: var(--accent); margin-top: 2px; letter-spacing: 0.12vw; text-shadow: 0 1px 6px #22334a22;}
        .img-btn:disabled { opacity: 0.4; cursor: not-allowed;}
        .slider-scale { display: flex; justify-content: space-between; margin-top: 0.05vh; font-size: 1.5vh; color: var(--accent2); width: 98%; margin-left: 1%; margin-right: 1%; letter-spacing: 0.13vw; font-weight: 600;}
        .param-group input[type=range] { width: 98%; margin-top: 0.5vh; accent-color: var(--slider-thumb); background: transparent; height: 2.5vh;}
        input[type=range]::-webkit-slider-runnable-track { height: 8px; border-radius: 5px; background: linear-gradient(to right, var(--slider-fill) 0%, var(--slider-fill) var(--slider-fill-percent, 0%), var(--slider-track) var(--slider-fill-percent, 0%), var(--slider-track) 100%);}
        input[type=range]::-webkit-slider-thumb { background: var(--slider-thumb); border-radius: 50%; width: 20px; height: 20px; border: 2px solid #fff; box-shadow: 0 2px 8px #00fff744; cursor: pointer; transition: background 0.2s; margin-top: -6px;}
        input[type=range]:focus { outline: none; }
        .button-group { margin-top: 1.7vh; display: flex; gap: 8vw; align-items: center; justify-content: center;}
        .button-group button { padding: 1.2vh 3vw; font-size: 2.1vh; border: none; border-radius: 13px; background: var(--btn-bg, #23395d); color: var(--text-main); cursor: pointer; transition: background 0.22s, transform 0.17s, color 0.20s, box-shadow 0.17s; font-weight: 700; box-shadow: 0 2px 18px #00fff722; outline: none; position: relative;}
        .button-group button:disabled { background: #3d495c; color: #666; cursor: not-allowed;}
        .button-group button:hover:not(:disabled) { background: var(--btn-hover, #00FFF7); color: #222; transform: scale(1.12); z-index: 3; box-shadow: 0 4px 44px #00fff755;}
        .button-group button:active:not(:disabled) { background: var(--btn-active, #313a55); color: #fff;}
        #right-section { width: 68%; min-width: 440px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background: none; border-top-right-radius: 32px; border-bottom-right-radius: 32px; border-top-left-radius: 0; border-bottom-left-radius: 0; box-shadow: 0 2px 14px #0009; position: relative;}
        #instructions-box { position: absolute; left: 2vw; top: 2vh; z-index: 5; min-width: 220px; min-height: 58px; max-width: 330px; background: #22334a; border: 2px solid var(--accent); border-radius: 18px; box-shadow: 0 2px 14px #1A202C20; padding: 1.2vh 1vw 1.2vh 1vw; display: flex; flex-direction: column; align-items: flex-start;}
        #instructions-box h2 { color: var(--accent); margin-bottom: 0.3vh; font-size: 2.2vh; letter-spacing: 0.7px; font-weight: 900; text-shadow: 0 2px 8px #00FFF733; font-family: Arial, sans-serif;}
        #instructions-text { color: #fff; font-size: 2.3vh; font-weight: 700; text-shadow: 0 0.5px 0.5px #00FFF711; margin-top: 0; font-family: Arial, sans-serif; letter-spacing: 0.3px;}
        #simulator-canvas { width: 460px; height: 375px; background: none; border-radius: 22px; position: relative; margin: 18vh auto 0 auto; display: flex; align-items: center; justify-content: center; box-shadow: none;}
        #sim-canvas { width: 460px; height: 375px; background: transparent; display: block; border-radius: 24px; position: absolute; top: 0; left: 0;}
        #simulator-clock { position: absolute; top: 2vh; right: 2vw; background: #101f2d; color: #00FFF7; padding: 1.2vh 2.5vw; border-radius: 18px; font-size: 2.8vh; border: 2.5px solid #00FFF7; box-shadow: 0 1px 12px #00fff722; font-weight: 900; letter-spacing: 1.4px; transition: box-shadow 0.2s; z-index: 10; font-family: Arial, sans-serif;}
        #result-section { width: 95%; margin-left: 2.5%; margin-bottom: 2.5vh; background: #232b3a; border-radius: 22px; box-shadow: 0 2px 22px #0e223e33; padding: 2.8vh 2.2vw 2.5vh 2.2vw; display: flex; flex-direction: row; justify-content: space-between; border: 1.5px solid #2c3a55; position: absolute; left: 0; bottom: 0;}
        #result-panel, #reaction-panel { width: 46%;}
        #result-panel h3, #reaction-panel h3 { color: var(--accent); font-size: 2.7vh; margin-bottom: 1.8vh; font-weight: bold; letter-spacing: 0.6px; font-family: Arial, sans-serif;}
        #corrosion-rate { font-size: 2.36vh; color: var(--accent); margin-top: 1.7vh; letter-spacing: 0.44px; font-weight: 700;}
        #oxidation-reaction, #reduction-reaction { font-size: 1.95vh; color: var(--text-main); margin-top: 1.2vh; letter-spacing: 0.3px;}
        #popup-bg { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.62); z-index: 9999; display: none; align-items: center; justify-content: center; pointer-events: none;}
        #popup { background: #101f2d; padding: 3vh 3vw; border-radius: 20px; border: 3.5px solid #00FFF7; color: #fff; font-size: 2.8vh; font-weight: bold; box-shadow: 0 4px 44px #00fff777; text-align: center; letter-spacing: 1.2px; pointer-events: auto; display: flex; flex-direction: column; align-items: center;}
        #popup-sub { font-size: 1.7vh; color: var(--accent); margin-top: 0.7em; font-weight: 400; letter-spacing: 0.4px;}
        .ghost-rod-outline {
            position: absolute;
            left: 210px;
            top: 40px;
            width: 40px;
            height: 280px;
            border: 2.5px dashed #00FFF7;
            border-radius: 8px;
            opacity: 0.4;
            pointer-events: none;
            z-index: 55;
            background: none;
        }
        .ghost-electrolyte-outline {
            position: absolute;
            left: 60px;
            top: 75px;
            width: 340px;
            height: 220px;
            border: 2.5px dashed #00FFF7;
            opacity: 0.22;
            pointer-events: none;
            z-index: 55;
            border-radius: 30%/18%;
        }
        .draggable-metal-img {
            position: absolute;
            z-index: 99;
            width: 54px;
            height: 54px;
            border-radius: 10px;
            box-shadow: 0 6px 22px #0008;
            opacity: 0.98;
            pointer-events: none;
            transition: box-shadow 0.20s;
        }
        .draggable-rod, .draggable-electrolyte { position: absolute; z-index: 99; cursor: grab; transition: box-shadow 0.20s, transform 0.25s;}
        .electrolyte-fill-anim { position: absolute; left: 60px; top: 75px; width: 340px; height: 220px; z-index: 60; pointer-events: none;}
        .snap-anim { animation: snapin 0.31s cubic-bezier(.71,1.8,.35,-0.81);}
        @keyframes snapin {
            0% { transform: scale(1.1) rotate(-6deg);}
            60% { transform: scale(1.18,0.88) rotate(3deg);}
            100% { transform: scale(1) rotate(0deg);}
        }
        @media (max-width: 1200px) { #sim-canvas { width: 320px; height: 260px; } #result-section { font-size: 1.2vh; } }
        @media (max-width: 900px) { #main-content { flex-direction: column; height: 78vh; } #controls-panel, #right-section { width: 100%; } #right-section { min-width: unset; } #result-section { width: 100%; margin: 2vh 0 0 0; } #instructions-box { left: 1vw; top: 1vh; } }
    </style>
</head>
<body>
    <!-- ... HTML unchanged ... -->
    <div id="header-bar">
        <div style="width:2vw;min-width:32px;"></div>
        <div id="header-title">Corrosion Rate Measurement Simulator</div>
    </div>
    <div id="main-content">
        <div id="controls-panel">
            <div id="controls-content">
                <div class="param-group">
                    <label>Metal</label>
                    <div class="image-button-group" id="metal-btn-group">
                        <button class="img-btn" data-metal="iron" id="metal-iron" title="Iron">
                            <img src="iron1.jpeg" alt="Iron">
                            <span class="metal-code">Fe</span>
                        </button>
                        <button class="img-btn" data-metal="zinc" id="metal-zinc" title="Zinc">
                            <img src="zinc-2-new.png" alt="Zinc">
                            <span class="metal-code">Zn</span>
                        </button>
                        <button class="img-btn" data-metal="copper" id="metal-copper" title="Copper">
                            <img src="copper.jpeg" alt="Copper">
                            <span class="metal-code">Cu</span>
                        </button>
                    </div>
                </div>
                <div class="param-group">
                    <label>Electrolyte</label>
                    <div class="image-button-group" id="electrolyte-btn-group">
                        <button class="img-btn" data-electrolyte="water" id="electrolyte-water" title="Water">
                            <img src="https://img.icons8.com/fluency/48/water.png" alt="Water" draggable="true">
                            <span class="elec-code">H₂O</span>
                        </button>
                        <button class="img-btn" data-electrolyte="nacl" id="electrolyte-nacl" title="Sodium Chloride">
                            <img src="https://img.icons8.com/fluency/48/salt.png" alt="NaCl" draggable="true">
                            <span class="elec-code">NaCl</span>
                        </button>
                        <button class="img-btn" data-electrolyte="h2so4" id="electrolyte-h2so4" title="Sulphuric Acid">
                            <img src="H2SO4.jpeg" alt="H₂SO₄" draggable="true">
                            <span class="elec-code">H₂SO₄</span>
                        </button>
                    </div>
                </div>
                <div class="param-group">
                    <label for="concentration-slider">Concentration</label>
                    <input type="range" id="concentration-slider" min="1" max="5" value="1" step="1" disabled>
                    <div class="slider-scale" id="concentration-scale">
                        <span>0.1M</span>
                        <span>1M</span>
                        <span>4M</span>
                        <span>7M</span>
                        <span>10M</span>
                    </div>
                </div>
                <div class="param-group">
                    <label for="time-slider">Exposure Time</label>
                    <input type="range" id="time-slider" min="1" max="5" value="1" step="1" disabled>
                    <div class="slider-scale" id="time-scale">
                        <span>1 hr</span>
                        <span>3 hr</span>
                        <span>5 hr</span>
                        <span>7 hr</span>
                        <span>10 hr</span>
                    </div>
                </div>
                <div class="param-group">
                    <label for="temp-slider">Temperature</label>
                    <input type="range" id="temp-slider" min="1" max="5" value="1" step="1" disabled>
                    <div class="slider-scale" id="temp-scale">
                        <span>25°C</span>
                        <span>40°C</span>
                        <span>60°C</span>
                        <span>80°C</span>
                        <span>100°C</span>
                    </div>
                </div>
                <div class="button-group">
                    <button id="start-btn" disabled>Start</button>
                    <button id="reset-btn" disabled>Reset</button>
                </div>
            </div>
        </div>
        <div id="right-section">
            <div id="instructions-box">
                <h2>Instructions</h2>
                <p id="instructions-text">Step 1: Select and drag the metal rod to the beaker</p>
            </div>
            <div id="simulator-clock">
                <span id="clock-time">00:00</span>
            </div>
            <div id="simulator-canvas">
                <canvas id="sim-canvas" width="460" height="375"></canvas>
            </div>
            <div id="result-section">
                <div id="result-panel">
                    <h3>Result</h3>
                    <div id="corrosion-rate">Corrosion Rate: --</div>
                </div>
                <div id="reaction-panel">
                    <h3>Reactions</h3>
                    <div id="oxidation-reaction">Oxidation: --</div>
                    <div id="reduction-reaction">Reduction: --</div>
                </div>
            </div>
        </div>
    </div>
    <div id="popup-bg" style="pointer-events:none;">
        <div id="popup">
            No reaction. Copper does not react with water and NaCl.
            <span id="popup-sub"><sub>Press Reset</sub></span>
        </div>
    </div>
<script>
  // ---- JS CODE FOR CORROSION RATE SIMULATOR ----

  // Color and reaction tables
  // ------- CONSTANTS -------
  const rodColors = {
      iron:   { initial: "#7D7D7D", final: "#8B0000" },
      zinc:   { initial: "#A2C5D3", final: "#435966" },
      copper: { initial: "#B87333", final: "#228B22" }
  };
  const electrolyteColors = {
      water: "#E3FAF8",
      nacl: "#1E90FF",
      h2so4: "#F3FCB1"
  };
  const ionColors = {
      iron: ["#FFD600", "#C0C0C0"],
      zinc: ["#FFD600", "#A2C5D3"],
      copper: ["#FFD600", "#B87333"]
  };
  const modeMatrix = {
      iron:   { water: 2, nacl: 4, h2so4: 5 },
      zinc:   { water: 1, nacl: 3, h2so4: 4 },
      copper: { water: 0, nacl: 0, h2so4: 1 }
  };
  const modeToRodPercent = { 0:0, 1:0.15, 2:0.30, 3:0.45, 4:0.60, 5:0.75 };
  const modeToIonSpeed = { 0:0, 1:0.5, 2:1, 3:1.7, 4:2.3, 5:3 };
  const concentrationMap = {1: '0.1M', 2: '1M', 3: '4M', 4: '7M', 5: '10M'};
  const timeMap = {1: '1 hr', 2: '3 hr', 3: '5 hr', 4: '7 hr', 5: '10 hr'};
  const tempMap = {1: '25°C', 2: '40°C', 3: '60°C', 4: '80°C', 5: '100°C'};
  const reactionTable = {
      iron: {
          water:  {ox: "Fe → Fe²⁺ + 2e⁻", red: "O₂ + 2H⁺ + 2e⁻ → H₂O"},
          nacl:   {ox: "Fe → Fe²⁺ + 2e⁻", red: "O₂ + 2H₂O + 4e⁻ → 4OH⁻"},
          h2so4:  {ox: "Fe → Fe²⁺ + 2e⁻", red: "2H⁺ + 2e⁻ → H₂"}
      },
      zinc: {
          water:  {ox: "Zn → Zn²⁺ + 2e⁻", red: "2H₂O + 2e⁻ → H₂ + 2OH⁻"},
          nacl:   {ox: "Zn → Zn²⁺ + 2e⁻", red: "2Cl⁻ + 2e⁻ → Cl₂"},
          h2so4:  {ox: "Zn → Zn²⁺ + 2e⁻", red: "2H⁺ + 2e⁻ → H₂"}
      },
      copper: {
          water:  {ox: "No reaction", red: "No reaction"},
          nacl:   {ox: "No reaction", red: "No reaction"},
          h2so4:  {ox: "Cu → Cu²⁺ + 2e⁻", red: "2H₂SO₄ + 2e⁻ → CuSO₄ + SO₂"}
      }
  };

  // ------- DOM -------
  const instructionsText = document.getElementById('instructions-text');
  const metalBtns = document.querySelectorAll('#metal-btn-group .img-btn');
  const electrolyteBtns = document.querySelectorAll('#electrolyte-btn-group .img-btn');
  const concentrationSlider = document.getElementById('concentration-slider');
  const timeSlider = document.getElementById('time-slider');
  const tempSlider = document.getElementById('temp-slider');
  const startBtn = document.getElementById('start-btn');
  const resetBtn = document.getElementById('reset-btn');
  const corrosionRateDiv = document.getElementById('corrosion-rate');
  const oxidationDiv = document.getElementById('oxidation-reaction');
  const reductionDiv = document.getElementById('reduction-reaction');
  const clockTime = document.getElementById('clock-time');
  const simCanvas = document.getElementById('sim-canvas');
  const ctx = simCanvas.getContext('2d');
  const popupBg = document.getElementById('popup-bg');
  const simulatorCanvasDiv = document.getElementById('simulator-canvas');

  // ------- STATE -------
  let stage = 0;
  let selectedMetal = null;
  let selectedElectrolyte = null;
  let simInterval = null;
  let clockInterval = null;
  let ions = [];
  let rodTransition = 0;
  let modeAvg = 0;
  let endingIonsFade = false;
  let elapsedClock = 0;
  let rodPlaced = false;
  let electrolytePlaced = false;
  let dragMetalImg = null;
  let ghostRod = null;
  let ghostElectrolyte = null;
  let fillAnimDiv = null;
  let dragElectrolyteEl = null;

  // ------- UI/Utility Functions -------
  function updateInstructions() {
      if (!rodPlaced) return instructionsText.innerText = "Step 1: Select and drag the metal rod to the beaker";
      if (!electrolytePlaced) return instructionsText.innerText = "Step 2: Drag the electrolyte icon into the beaker";
      if (stage === 2) return instructionsText.innerText = "Step 3: Adjust parameters and start experiment";
      if (stage === 3) return instructionsText.innerText = "Step 4: Wait till reaction completes";
      if (stage === 4) return instructionsText.innerText = "Reaction ends. Press Reset";
      instructionsText.innerText = "";
  }
  function updateControls() {
      electrolyteBtns.forEach(b => b.disabled = (!rodPlaced));
      let enableParams = (rodPlaced && electrolytePlaced);
      concentrationSlider.disabled = !enableParams;
      timeSlider.disabled = !enableParams;
      tempSlider.disabled = !enableParams;
      startBtn.disabled = !enableParams;
      resetBtn.disabled = (stage < 3);
  }
  function clearResult() {
      corrosionRateDiv.innerText = "Corrosion Rate: --";
      oxidationDiv.innerText = "Oxidation: --";
      reductionDiv.innerText = "Reduction: --";
  }
  function showPopup() { popupBg.style.display = 'flex'; popupBg.style.pointerEvents = "none"; resetBtn.style.zIndex = 10001; resetBtn.disabled = false; }
  function hidePopup() { popupBg.style.display = 'none'; popupBg.style.pointerEvents = "none"; resetBtn.style.zIndex = ""; }

  // ------- Ghost Outlines -------
  function showGhostRod() {
      if (ghostRod) ghostRod.remove();
      ghostRod = document.createElement('div');
      ghostRod.className = "ghost-rod-outline";
      ghostRod.style.left = "210px";
      ghostRod.style.top = "40px";
      ghostRod.style.width = "40px";
      ghostRod.style.height = "280px";
      simulatorCanvasDiv.appendChild(ghostRod);
  }
  function hideGhostRod() { if (ghostRod) { ghostRod.remove(); ghostRod = null; } }
  function showGhostElectrolyte() {
      if (ghostElectrolyte) ghostElectrolyte.remove();
      ghostElectrolyte = document.createElement('div');
      ghostElectrolyte.className = "ghost-electrolyte-outline";
      ghostElectrolyte.style.left = "60px";
      ghostElectrolyte.style.top = "75px";
      ghostElectrolyte.style.width = "340px";
      ghostElectrolyte.style.height = "220px";
      simulatorCanvasDiv.appendChild(ghostElectrolyte);
  }
  function hideGhostElectrolyte() { if (ghostElectrolyte) { ghostElectrolyte.remove(); ghostElectrolyte = null; } }

  /*function flashBeaker(color, ms) {
      let beaker = document.createElement('div');
      beaker.style.position = "absolute";
      beaker.style.left = "60px";
      beaker.style.top = "40px";
      beaker.style.width = "340px";
      beaker.style.height = "282px";
      beaker.style.borderRadius = "30px/19px";
      beaker.style.background = color;
      beaker.style.opacity = "0.23";
      beaker.style.zIndex = "111";
      simulatorCanvasDiv.appendChild(beaker);
      setTimeout(() => beaker.remove(), ms);
  }*/

  // ------- METAL DRAG & DROP -------
  metalBtns.forEach(btn => {
      const img = btn.querySelector("img");
      img.style.cursor = "grab";
      img.addEventListener('mousedown', function(ev) {
          if (rodPlaced) return;
          ev.preventDefault();
          startMetalDrag(img, btn, false, ev);
      });
      img.addEventListener('touchstart', function(ev) {
          if (rodPlaced) return;
          ev.preventDefault();
          startMetalDrag(img, btn, true, ev);
      }, {passive:false});
  });
  function startMetalDrag(img, btn, isTouch=false, ev=null) {
      if (dragMetalImg) dragMetalImg.remove();
      dragMetalImg = document.createElement('img');
      dragMetalImg.src = img.src;
      dragMetalImg.className = "draggable-metal-img";
      dragMetalImg.style.width = "54px";
      dragMetalImg.style.height = "54px";
      let x, y;
      if (isTouch && ev) {
          x = ev.touches[0].clientX - 27;
          y = ev.touches[0].clientY - 27;
      } else if (ev) {
          x = ev.clientX - 27;
          y = ev.clientY - 27;
      } else {
          x = 0; y = 0;
      }
      dragMetalImg.style.left = x + "px";
      dragMetalImg.style.top = y + "px";
      document.body.appendChild(dragMetalImg);

      showGhostRod();
      let offsetX = 27, offsetY = 27, dragging = true;
      let metal = btn.getAttribute('data-metal');
      document.addEventListener('mousemove', dragMove);
      document.addEventListener('touchmove', dragMove, {passive:false});
      document.addEventListener('mouseup', dragEnd);
      document.addEventListener('touchend', dragEnd);

      function dragMove(e) {
          let pageX, pageY;
          if (e.touches) {
              pageX = e.touches[0].clientX;
              pageY = e.touches[0].clientY;
          } else {
              pageX = e.clientX;
              pageY = e.clientY;
          }
          dragMetalImg.style.left = (pageX - offsetX) + "px";
          dragMetalImg.style.top = (pageY - offsetY) + "px";
          if (rodInGhost(pageX - offsetX, pageY - offsetY, dragMetalImg)) {
              ghostRod.style.borderColor = "#00FFF7";
              ghostRod.style.opacity = 0.63;
          } else {
              ghostRod.style.borderColor = "#00FFF7";
              ghostRod.style.opacity = 0.4;
          }
      }
      function dragEnd(e) {
          dragging = false;
          document.removeEventListener('mousemove', dragMove);
          document.removeEventListener('touchmove', dragMove);
          document.removeEventListener('mouseup', dragEnd);
          document.removeEventListener('touchend', dragEnd);
          let rect = dragMetalImg.getBoundingClientRect();
          let x = rect.left, y = rect.top;
          if (rodInGhost(x, y, dragMetalImg)) {
              dragMetalImg.style.transition = "all 0.3s cubic-bezier(.24,1.85,.51,-0.2)";
              let ghostRect = ghostRod.getBoundingClientRect();
              dragMetalImg.style.left = (ghostRect.left + ghostRect.width/2 - 27) + "px";
              dragMetalImg.style.top = (ghostRect.top + ghostRect.height/2 - 27) + "px";
              dragMetalImg.classList.add("snap-anim");
              setTimeout(() => {
                  dragMetalImg.remove();
                  dragMetalImg = null;
                  rodPlaced = true;
                  selectedMetal = metal;
                  hideGhostRod();
                  updateInstructions();
                  updateControls();
                  drawInitialCanvas();
                  flashBeaker("#00FFF7", 160);
              }, 310);
          } else {
              dragMetalImg.remove();
              dragMetalImg = null;
              hideGhostRod();
          }
      }
  }
  function rodInGhost(x, y, dragEl) {
      if (!ghostRod) return false;
      let ghostRect = ghostRod.getBoundingClientRect();
      let rodRect = dragEl.getBoundingClientRect();
      let overlap = !(rodRect.right < ghostRect.left + 8 ||
                      rodRect.left > ghostRect.right - 8 ||
                      rodRect.bottom < ghostRect.top + 10 ||
                      rodRect.top > ghostRect.bottom - 10);
      return overlap;
  }

  // ------- ELECTROLYTE DRAG & DROP -------
  electrolyteBtns.forEach(btn => {
      btn.disabled = true;
      const img = btn.querySelector("img");
      img.style.cursor = "grab";
      img.addEventListener('mousedown', function(ev) {
          if (!rodPlaced || electrolytePlaced) return;
          ev.preventDefault();
          startElectrolyteDrag(img, btn);
      });
      img.addEventListener('touchstart', function(ev) {
          if (!rodPlaced || electrolytePlaced) return;
          ev.preventDefault();
          startElectrolyteDrag(img, btn, true, ev);
      }, {passive:false});
  });
  function startElectrolyteDrag(img, btn, isTouch = false, touchEv = null) {
      if (dragElectrolyteEl) dragElectrolyteEl.remove();
      dragElectrolyteEl = document.createElement('img');
      dragElectrolyteEl.className = 'draggable-electrolyte';
      dragElectrolyteEl.src = img.src;
      dragElectrolyteEl.style.width = "54px";
      dragElectrolyteEl.style.height = "54px";
      let x, y;
      if (isTouch && touchEv) {
          x = touchEv.touches[0].clientX - 27;
          y = touchEv.touches[0].clientY - 27;
      } else {
          x = event.clientX - 27;
          y = event.clientY - 27;
      }
      dragElectrolyteEl.style.left = x + "px";
      dragElectrolyteEl.style.top = y + "px";
      dragElectrolyteEl.style.opacity = "0.96";
      dragElectrolyteEl.style.boxShadow = "0 6px 18px #0007";
      dragElectrolyteEl.style.position = "absolute";
      dragElectrolyteEl.style.zIndex = "91";
      document.body.appendChild(dragElectrolyteEl);

      let offsetX = 27, offsetY = 27, dragging = true;
      document.addEventListener('mousemove', dragMove);
      document.addEventListener('touchmove', dragMove, {passive:false});
      document.addEventListener('mouseup', dragEnd);
      document.addEventListener('touchend', dragEnd);

      if (!ghostElectrolyte) showGhostElectrolyte();

      function dragMove(e) {
          let pageX, pageY;
          if (e.touches) {
              pageX = e.touches[0].clientX;
              pageY = e.touches[0].clientY;
          } else {
              pageX = e.clientX;
              pageY = e.clientY;
          }
          dragElectrolyteEl.style.left = (pageX - offsetX) + "px";
          dragElectrolyteEl.style.top = (pageY - offsetY) + "px";
          if (electrolyteInGhost(pageX - offsetX, pageY - offsetY)) {
              ghostElectrolyte.style.borderColor = "#00FFF7";
              ghostElectrolyte.style.opacity = 0.41;
          } else {
              ghostElectrolyte.style.borderColor = "#00FFF7";
              ghostElectrolyte.style.opacity = 0.22;
          }
      }
      function dragEnd(e) {
          dragging = false;
          document.removeEventListener('mousemove', dragMove);
          document.removeEventListener('touchmove', dragMove);
          document.removeEventListener('mouseup', dragEnd);
          document.removeEventListener('touchend', dragEnd);
          let rect = dragElectrolyteEl.getBoundingClientRect();
          let x = rect.left, y = rect.top;
          if (electrolyteInGhost(x, y)) {
              dragElectrolyteEl.style.transition = "all 0.3s cubic-bezier(.24,1.85,.51,-0.2)";
              let ghostRect = ghostElectrolyte.getBoundingClientRect();
              dragElectrolyteEl.style.left = (ghostRect.left + ghostRect.width/2 - 27) + "px";
              dragElectrolyteEl.style.top = (ghostRect.top + ghostRect.height/2 - 27) + "px";
              dragElectrolyteEl.classList.add("snap-anim");
              setTimeout(() => {
                  dragElectrolyteEl.remove();
                  dragElectrolyteEl = null;
                  electrolytePlaced = true;
                  selectedElectrolyte = btn.getAttribute('data-electrolyte');
                  hideGhostElectrolyte();
                  animateElectrolyteFill(selectedElectrolyte, () => {
                      updateInstructions();
                      updateControls();
                      drawInitialCanvas();
                      flashBeaker("#00FFF7", 110);
                  });
              }, 310);
          } else {
              dragElectrolyteEl.remove();
              dragElectrolyteEl = null;
              hideGhostElectrolyte();
          }
      }
  }
  function electrolyteInGhost(x, y) {
      if (!ghostElectrolyte) return false;
      let ghostRect = ghostElectrolyte.getBoundingClientRect();
      let elRect = dragElectrolyteEl.getBoundingClientRect();
      let overlap = !(elRect.right < ghostRect.left + 10 ||
                      elRect.left > ghostRect.right - 10 ||
                      elRect.bottom < ghostRect.top + 10 ||
                      elRect.top > ghostRect.bottom - 10);
      return overlap;
  }
  function animateElectrolyteFill(electrolyte, cb) {
      if (fillAnimDiv) fillAnimDiv.remove();
      fillAnimDiv = document.createElement('canvas');
      fillAnimDiv.className = "electrolyte-fill-anim";
      fillAnimDiv.width = 340; fillAnimDiv.height = 220;
      simulatorCanvasDiv.appendChild(fillAnimDiv);
      let fctx = fillAnimDiv.getContext('2d');
      let frac = 0;
      let color = electrolyteColors[electrolyte];
      function drawFill(frac) {
          fctx.clearRect(0,0,340,220);
          fctx.save();
          fctx.globalAlpha = 0.91;
          fctx.fillStyle = color;
          fctx.beginPath();
          fctx.ellipse(170,220-24,150,22,0,0,Math.PI*2,false);
          fctx.fill();
          let h = Math.round(220*frac);
          fctx.fillRect(12, 220-h, 315, h);
          fctx.restore();
      }
      let anim = setInterval(() => {
          frac += 0.04;
          if (frac > 1) frac = 1;
          drawFill(frac);
          if (frac === 1) {
              clearInterval(anim);
              setTimeout(() => { fillAnimDiv.remove(); fillAnimDiv=null; if(cb)cb(); }, 220);
          }
      }, 16);
  }

  // ------- Sliders -------
  function updateSliderFill(r) {
      let percent = ((r.value - r.min) / (r.max - r.min)) * 100;
      r.style.setProperty('--slider-fill-percent', percent + '%');
  }
  [concentrationSlider, timeSlider, tempSlider].forEach(slider => {
      slider.addEventListener('input', function() {
          updateSliderFill(this);
          if (selectedElectrolyte && electrolytePlaced) drawInitialCanvas();
      });
      updateSliderFill(slider);
  });

  // ------- Simulation logic -------
  startBtn.addEventListener('click', () => {
      if (!rodPlaced || !electrolytePlaced) return;
      stage = 3;
      updateInstructions();
      updateControls();
      runSimulation();
      resetBtn.disabled = false;
      hidePopup();
  });
  resetBtn.addEventListener('click', resetAll);

  function getModeAvg() {
      const m1 = modeMatrix[selectedMetal][selectedElectrolyte];
      const m2 = Number(concentrationSlider.value);
      const m3 = Number(timeSlider.value);
      const m4 = Number(tempSlider.value);
      if (m1 === 0 || m2 === 0 || m3 === 0 || m4 === 0) return 0;
      return Math.round((m1 + m2 + m3 + m4)/4);
  }

  // --- SIMULATION CLOCK LOGIC (1hr = 3sec, 1min = 0.05sec, show update every minute) ---
  // ------- FIXED RODTRANSITION LOGIC BELOW -------
  function runSimulation() {
      modeAvg = getModeAvg();
      if (
          modeMatrix[selectedMetal][selectedElectrolyte] === 0 ||
          Number(concentrationSlider.value) === 0 ||
          Number(timeSlider.value) === 0 ||
          Number(tempSlider.value) === 0 ||
          modeAvg === 0
      ) {
          setTimeout(() => {
              showPopup();
              stage = 4;
              updateInstructions();
              resetBtn.disabled = false;
          }, 400);
          corrosionRateDiv.innerText = "Corrosion Rate: 0";
          oxidationDiv.innerText = "Oxidation: No reaction";
          reductionDiv.innerText = "Reduction: No reaction";
          drawInitialCanvas();
          return;
      }
      // 1hr = 3 sec; 1min = 0.05sec
      var userHrs = Number(timeMap[timeSlider.value].split(' ')[0]);
      var userMins = 0;
      var totalClockMinutes = userHrs * 60 + userMins;
      var totalSimSeconds = totalClockMinutes * 0.05; // (1min = 0.05s)

      let rodPercent = modeToRodPercent[modeAvg];
      rodTransition = 0;
      ions = [];
      endingIonsFade = false;
      elapsedClock = 0;
      drawInitialCanvas();
      document.querySelector("#simulator-clock #clock-time").textContent = "00:00";
      clearInterval(clockInterval);

      let displayedMinutes = 0;
      let totalTicks = totalClockMinutes; // one tick per minute
      let tickIntervalMs = 50; // 0.05 sec per min = 50ms per tick

      clockInterval = setInterval(() => {
          displayedMinutes++;
          let hrs = Math.floor(displayedMinutes / 60);
          let mins = displayedMinutes % 60;
          let out = (hrs < 10 ? "0" : "") + hrs + ":" + (mins < 10 ? "0" : "") + mins;
          document.querySelector("#simulator-clock #clock-time").textContent = out;
          if (displayedMinutes >= totalClockMinutes) {
              clearInterval(clockInterval);
              endingIonsFade = true;
              setTimeout(() => {
                  clearInterval(simInterval);
                  stage = 4;
                  updateInstructions();
                  updateControls();
                  showResults();
              }, 1200);
          }
      }, tickIntervalMs);

      clearInterval(simInterval);
      // FIX: Animate rodTransition from 0 to 1, not up to rodPercent!
      let totalRodAnimFrames = totalSimSeconds * 60;
      simInterval = setInterval(() => {
          if (rodTransition < 1) {
              rodTransition += 1 / totalRodAnimFrames;
              if (rodTransition > 1) rodTransition = 1;
          }
          updateIons(modeAvg, totalSimSeconds, endingIonsFade);
          drawSimulation(rodTransition, ions, rodPercent, modeAvg);
      }, 1000/60);
  }

  // ------- Drawing Functions -------
  function drawInitialCanvas() {
      ctx.clearRect(0, 0, simCanvas.width, simCanvas.height);
      drawBeaker();
      if (electrolytePlaced && selectedElectrolyte) drawElectrolyte(selectedElectrolyte);
      if (rodPlaced && selectedMetal) drawRod(selectedMetal, rodColors[selectedMetal].initial, 1);
  }
  function drawSimulation(rodTrans, ionsArr, rodPercent, modeAvg) {
      ctx.clearRect(0, 0, simCanvas.width, simCanvas.height);
      drawBeaker();
      if (electrolytePlaced && selectedElectrolyte) drawElectrolyte(selectedElectrolyte);
      if (rodPlaced && selectedMetal) drawRodTransition(selectedMetal, rodTrans, rodPercent);
      ionsArr.forEach(ion => drawIon(ion));
  }
  function drawBeaker() {
      ctx.save();
      ctx.strokeStyle = "rgba(138, 215, 255, 0.77)";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(60, 40); ctx.lineTo(60, 320);
      ctx.moveTo(400, 40); ctx.lineTo(400, 320);
      ctx.stroke();
      ctx.beginPath();
      ctx.ellipse(230, 320, 170, 26, 0, 0, 2*Math.PI, false);
      ctx.stroke();
      ctx.globalAlpha = 0.23;
      ctx.fillStyle = "#aee7ff";
      ctx.beginPath();
      ctx.ellipse(230, 320, 170, 26, 0, 0, 2*Math.PI, false);
      ctx.fill();
      ctx.restore();
  }
  function drawElectrolyte(electrolyte) {
      let fillY = 295;
      let fillHeight = 220;
      let fillColor = electrolyteColors[electrolyte];
      let c = Number(concentrationSlider.value);
      let t = Number(timeSlider.value);
      let temp = Number(tempSlider.value);
      let opacity = 0.91 + 0.015 * ((c + t + temp) / 3 - 1);
      ctx.save();
      ctx.globalAlpha = opacity;
      ctx.fillStyle = fillColor;
      ctx.beginPath();
      ctx.ellipse(230, fillY, 170, 24, 0, Math.PI*2, false);
      ctx.fill();
      ctx.fillRect(60, fillY-fillHeight, 340, fillHeight);
      ctx.restore();
  }
  function drawRod(metal, color, fillFrac=1) {
      const rodY = 40;
      const rodH = 280;
      ctx.save();
      ctx.beginPath();
      ctx.rect(210, rodY, 40, rodH * fillFrac);
      ctx.fillStyle = color;
      ctx.fill();
      ctx.restore();
  }
  function drawRodTransition(metal, rodTransition, rodPercent) {
      let rodH = 280, rodY = 40;
      let transH = rodTransition * rodPercent * rodH;
      if (isNaN(transH) || rodPercent === 0) transH = 0;

      ctx.save();
      // Uncorroded part
      ctx.beginPath();
      ctx.rect(210, rodY, 40, rodH - transH);
      ctx.fillStyle = rodColors[metal].initial;
      ctx.fill();

      // Corroded part (from bottom up to transH)
      if (transH > 0) {
          let grad = ctx.createLinearGradient(0, rodY + rodH - transH, 0, rodY + rodH);
          grad.addColorStop(0, rodColors[metal].initial);
          grad.addColorStop(1, rodColors[metal].final);
          ctx.beginPath();
          ctx.rect(210, rodY + rodH - transH, 40, transH);
          ctx.fillStyle = grad;
          ctx.fill();
      }
      ctx.restore();
  }

  // ------- Ions & Results -------
  function updateIons(mode, simSeconds, fadeAll=false) {
      if (mode === 0) { ions = []; return; }
      let speed = modeToIonSpeed[mode];
      if (!fadeAll && Math.random() < 0.13 * speed) {
          let ionPair = ionColors[selectedMetal];
          ions.push({
              x: 230-32+Math.random()*18, y: 318, color: ionPair[0], vy: -speed, vx: (Math.random()-0.5)*speed, type: "e", alpha: 1
          });
          ions.push({
              x: 230+32-Math.random()*18, y: 318, color: ionPair[1], vy: -speed, vx: (Math.random()-0.5)*speed, type: "m", alpha: 1
          });
      }
      // Electrolyte top surface
      const fluidY = 295 - 220;
      const disappearY = fluidY + 20; // disappear just before top surface
      ions.forEach(ion => {
          ion.x += ion.vx + (Math.random()-0.5)*0.4;
          ion.y += ion.vy + (Math.random()-0.5)*0.2;
          if (ion.x < 68) { ion.x = 68; ion.vx *= -1; }
          if (ion.x > 392) { ion.x = 392; ion.vx *= -1; }
          if (ion.x > 210 && ion.x < 250 && ion.y > 40 && ion.y < 320) {
              if (ion.x < 230) ion.x = 210;
              else ion.x = 250;
              ion.vx *= -1;
          }
          if (ion.y < disappearY) {
              ion.alpha -= 0.09;
              if (ion.alpha < 0) ion.alpha = 0;
          }
          if (fadeAll) {
              ion.alpha -= 0.033;
              if (ion.alpha < 0) ion.alpha = 0;
          }
      });
      ions = ions.filter(ion => ion.y > fluidY && ion.y < 318 && ion.alpha > 0.01);
  }
  function drawIon(ion) {
      ctx.save();
      ctx.beginPath();
      ctx.arc(ion.x, ion.y, 7, 0, Math.PI*2);
      ctx.globalAlpha = (ion.type === "e" ? 0.7 : 0.88) * ion.alpha;
      ctx.fillStyle = ion.color;
      ctx.shadowColor = ion.color;
      ctx.shadowBlur = 5 * ion.alpha;
      ctx.fill();
      ctx.restore();
  }
  function showResults() {
      const timeHrs = Number(timeSlider.value) === 1 ? 1 : Number(timeMap[timeSlider.value].split(' ')[0]);
      const corrosionRate = (10 / (5 * timeHrs)).toFixed(2);
      corrosionRateDiv.innerHTML = `Corrosion Rate: ${corrosionRate} <span style="font-size:1.6vh;color:#00FFF7;">µpy</span>`;
      const rxn = reactionTable[selectedMetal][selectedElectrolyte];
      oxidationDiv.innerText = "Oxidation: " + (rxn ? rxn.ox : "--");
      reductionDiv.innerText = "Reduction: " + (rxn ? rxn.red : "--");
  }
  function resetAll() {
      hidePopup();
      stage = 0;
      rodPlaced = false;
      electrolytePlaced = false;
      selectedMetal = null;
      selectedElectrolyte = null;
      metalBtns.forEach(b => b.classList.remove('selected'));
      electrolyteBtns.forEach(b => { b.classList.remove('selected'); b.disabled = true; });
      concentrationSlider.value = 1;
      timeSlider.value = 1;
      tempSlider.value = 1;
      updateSliderFill(concentrationSlider);
      updateSliderFill(timeSlider);
      updateSliderFill(tempSlider);
      updateInstructions();
      updateControls();
      clearResult();
      clearInterval(simInterval);
      clearInterval(clockInterval);
      document.querySelector("#simulator-clock #clock-time").textContent = "00:00";
      elapsedClock = 0;
      if (dragMetalImg) dragMetalImg.remove();
      if (dragElectrolyteEl) dragElectrolyteEl.remove();
      hideGhostRod();
      hideGhostElectrolyte();
      if (fillAnimDiv) fillAnimDiv.remove();
      drawInitialCanvas();
  }

  // ------- INIT -------
  drawInitialCanvas();

</script>
</body>
</html>
